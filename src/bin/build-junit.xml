<?xml version="1.0" encoding="UTF-8"?>
<project name="eSciDocCoreAdmin - run Junit Release Tests" basedir="../.." default="test">
	<path id="classpath">
		<fileset dir="${lib.dir}" includes="**/*.jar" />
		<dirset dir=".">
			<include name="${java.build.dir}/" />
		</dirset>
	</path>

	<path id="sources">
		<dirset dir=".">
			<include name="${java.src.dir}/" />
			<include name="${test.src.dir}/" />
		</dirset>
	</path>

	<path id="build.classpath">
		<path refid="classpath" />
		<path refid="sources" />
	</path>

	<property name="path" refid="build.classpath" />
	<echo level="info">Build classpath: ${path}</echo>

	<target name="clean">
		<delete dir="${junit.result.dir}" />
	</target>

	<target name="prepare">
		<mkdir dir="${junit.xml.result.dir}" />
	</target>

	<target name="merge-reports">
		<junitreport todir="${junit.result.dir}">
			<fileset dir="${junit.xml.result.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${junit.html.result.dir}" />
		</junitreport>
	</target>


	<!-- Run all JUnit tests and check if all were successful. If not, excecution fails! -->
	<target name="test-fail" depends="test">
		<available file="${junit.failed.file}" property="test.failed" />
		<fail message="At least one Test failed - Check test reports." if="test.failed" />
	</target>

	<!-- Run all JUnit tests -->
	<target name="test" depends="clean, prepare">
		<antcall target="execute-suite">
			<param name="junit.suite" value="de/escidoc/core/admin/test/reindexer/Suite.java" />
		</antcall>
	</target>

	<target name="execute-suite">
		<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask">
			<classpath>
				<pathelement location="lib/test/ant-junit.jar" />
				<pathelement location="lib/test/junit.jar" />
			</classpath>
		</taskdef>
		<echo level="info">RUN: Execute JUnit suite ${junit.suite}</echo>
		<junit errorproperty="test.failed" failureproperty="test.failed" fork="yes">
			<bootclasspath>
				<path path="${env.PATH}" />
				<path path="${env.JAVA_HOME}" />
				<path refid="build.classpath" />
				<pathelement path="${build.classpath}" />
				<dirset dir=".">
					<include name="${java.src.dir}" />
					<include name="${test.src.dir}" />
				</dirset>
			</bootclasspath>
			<classpath>
				<path refid="build.classpath" />
				<pathelement path="${build.classpath}" />
			</classpath>
			<formatter type="brief" usefile="false" />
			<formatter type="xml" />
			<batchtest fork="yes" todir="${junit.xml.result.dir}">
				<fileset dir="${test.src.dir}/">
					<include name="${junit.suite}" />
				</fileset>
			</batchtest>
			<sysproperty key="JAVA_HOME" value="${env.JAVA_HOME}" />
			<sysproperty key="PATH" value="${env.PATH}" />
		</junit>
		<antcall target="if-failed" />
		<echo level="info">DONE: Execute JUnit suite ${junit.suite}</echo>
	</target>

	<target name="if-failed" if="test.failed">
		<touch file="${junit.failed.file}" />
	</target>

</project>
